

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pisa Showcase, Example Notebook &mdash; Public Infrastructure Service Access 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=8d563738"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Contributing" href="../contributing.html" />
    <link rel="prev" title="Public Infrastructure Service Access (PISA)" href="../index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Public Infrastructure Service Access
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Pisa Showcase, Example Notebook</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Public Infrastructure Service Access</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Pisa Showcase, Example Notebook</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/examples/pisa_showcase_osm.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">optimization</span><span class="w"> </span><span class="kn">import</span> <span class="n">jg_opt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pisa.administrative_area</span><span class="w"> </span><span class="kn">import</span> <span class="n">AdministrativeArea</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pisa.facilities</span><span class="w"> </span><span class="kn">import</span> <span class="n">Facilities</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pisa.population</span><span class="w"> </span><span class="kn">import</span> <span class="n">WorldpopPopulation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pisa.population_served_by_isopolygons</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_population_served_by_isopolygons</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pisa.visualisation</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">plot_facilities</span><span class="p">,</span>
    <span class="n">plot_isochrones</span><span class="p">,</span>
    <span class="n">plot_population</span><span class="p">,</span>
    <span class="n">plot_population_heatmap</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:matplotlib.font_manager:Failed to extract font properties from /usr/share/fonts/truetype/noto/NotoColorEmoji.ttf: Can not load face (unknown file format; error code 0x2)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:matplotlib.font_manager:generated new fontManager
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="c1"># load environment variables from an `.env` file in the local root directory</span>
<span class="n">load_dotenv</span><span class="p">()</span>

<span class="n">CBC_SOLVER_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span>
    <span class="s2">&quot;CBC_SOLVER_PATH&quot;</span>
<span class="p">)</span>  <span class="c1"># path to the cbc executable (e.g. /opt/homebrew/bin/cbc)</span>
</pre></div>
</div>
</div>
</div>
<section id="pisa-showcase-example-notebook">
<h1>Pisa Showcase, Example Notebook<a class="headerlink" href="#pisa-showcase-example-notebook" title="Link to this heading"></a></h1>
<section id="use-case-example-notebook">
<h2>Use Case Example notebook<a class="headerlink" href="#use-case-example-notebook" title="Link to this heading"></a></h2>
<p>This notebook shows how to use the PISA package to calculate new locations for hospitals where it would have most impact, i.e. reach the highest possible number of people that currently do not have a hospital in their vicinity.</p>
<p>The example is based on the case of <code class="docutils literal notranslate"><span class="pre">Baucau,</span> <span class="pre">Timor-Leste</span></code>, and we are interested in the part of the population that cannot reach a hospital when driving 10 km. WorldPop is used as source to get the population count in <code class="docutils literal notranslate"><span class="pre">Baucau</span></code> area and the road network from OSM is used to identify their distance to current hospitals and potential locations for new facilities. Depending on the specified budget, the optimization will return a number of locations where new hospitals would reach the highest number of people that currently do not have a hospital in their vicinity.</p>
</section>
<section id="define-administrative-area">
<h2>Define Administrative Area<a class="headerlink" href="#define-administrative-area" title="Link to this heading"></a></h2>
<p>We need to define the administrative area that we want to work with. This is done in two steps:</p>
<ol class="arabic simple">
<li><p>Create an <code class="docutils literal notranslate"><span class="pre">AdministrativeArea</span></code> object with the country name and administrative level of interest.</p></li>
<li><p>Call the <code class="docutils literal notranslate"><span class="pre">get_admin_area_boundaries</span></code> method on this <code class="docutils literal notranslate"><span class="pre">AdministrativeArea</span></code> object with the name of the region of interest to get the boundaries of the administrative area. The regions that can be specified here are dependent on which administrative level was specified in the first step.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">timor_leste</span> <span class="o">=</span> <span class="n">AdministrativeArea</span><span class="p">(</span><span class="n">country_name</span><span class="o">=</span><span class="s2">&quot;Timor-Leste&quot;</span><span class="p">,</span> <span class="n">admin_level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># these are the boundaries of Baucau</span>
<span class="c1"># type: Polygon</span>
<span class="n">baucau</span> <span class="o">=</span> <span class="n">timor_leste</span><span class="o">.</span><span class="n">get_admin_area_boundaries</span><span class="p">(</span><span class="s2">&quot;Baucau&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:pisa.administrative_area:Validating country name: Timor-Leste
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:pisa.administrative_area:Country name &#39;Timor-Leste&#39; validated successfully
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:pisa.administrative_area:Retrieving boundaries of all administrative areas of level 1 for country Timor-Leste
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">timor_leste</span> <span class="o">=</span> <span class="n">AdministrativeArea</span><span class="p">(</span><span class="n">country_name</span><span class="o">=</span><span class="s2">&quot;Timor-Leste&quot;</span><span class="p">,</span> <span class="n">admin_level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="c1"># these are the boundaries of Baucau</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="c1"># type: Polygon</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">baucau</span> <span class="o">=</span> <span class="n">timor_leste</span><span class="o">.</span><span class="n">get_admin_area_boundaries</span><span class="p">(</span><span class="s2">&quot;Baucau&quot;</span><span class="p">)</span>

<span class="nn">File ~/work/Public-Infrastructure-Service-Access/Public-Infrastructure-Service-Access/pisa/administrative_area.py:86,</span> in <span class="ni">AdministrativeArea.__init__</span><span class="nt">(self, country_name, admin_level)</span>
<span class="g g-Whitespace">     </span><span class="mi">84</span> <span class="bp">self</span><span class="o">.</span><span class="n">country</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pycountry_from_country_name</span><span class="p">(</span><span class="n">country_name</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">85</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_level</span> <span class="o">=</span> <span class="n">admin_level</span>
<span class="ne">---&gt; </span><span class="mi">86</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_admin_areas_gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_admin_areas</span><span class="p">(</span><span class="n">country</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="p">,</span> <span class="n">admin_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">admin_level</span><span class="p">)</span>

<span class="nn">File ~/work/Public-Infrastructure-Service-Access/Public-Infrastructure-Service-Access/pisa/administrative_area.py:150,</span> in <span class="ni">AdministrativeArea._download_admin_areas</span><span class="nt">(country, admin_level)</span>
<span class="g g-Whitespace">    </span><span class="mi">148</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrieving boundaries of all administrative areas of level </span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2"> for country </span><span class="si">{</span><span class="n">country</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">149</span> <span class="n">downloader</span> <span class="o">=</span> <span class="n">GADMDownloader</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="s2">&quot;4.0&quot;</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">150</span> <span class="k">return</span> <span class="n">downloader</span><span class="o">.</span><span class="n">get_shape_data_by_country</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">151</span>     <span class="n">country</span><span class="o">=</span><span class="n">country</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">152</span>     <span class="n">ad_level</span><span class="o">=</span><span class="n">admin_level</span>
<span class="g g-Whitespace">    </span><span class="mi">153</span> <span class="p">)</span>

<span class="nn">File ~/.cache/pypoetry/virtualenvs/gpbp-OIyr1Vno-py3.10/lib/python3.10/site-packages/gadm/gadm_downloader.py:72,</span> in <span class="ni">GADMDownloader.get_shape_data_by_country</span><span class="nt">(self, country, ad_level)</span>
<span class="g g-Whitespace">     </span><span class="mi">70</span> <span class="n">abs_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GADMDownloader</span><span class="o">.</span><span class="n">__CACHED_DIR</span><span class="p">,</span> <span class="n">data_path</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">71</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">72</span>     <span class="n">download_url</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">73</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_url_root_dir</span> <span class="o">+</span> <span class="n">data_path</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">74</span>         <span class="n">abs_data_path</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">75</span>     <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">76</span> <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">77</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failed to fetch data for </span><span class="si">{</span><span class="n">country</span><span class="o">.</span><span class="n">common_name</span><span class="si">}</span><span class="s2"> with error </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nn">File ~/.cache/pypoetry/virtualenvs/gpbp-OIyr1Vno-py3.10/lib/python3.10/site-packages/gadm/utils.py:23,</span> in <span class="ni">download_url</span><span class="nt">(url, file_path)</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="k">def</span><span class="w"> </span><span class="nf">download_url</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;download file from url</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span><span class="sd"> </span>
<span class="g g-Whitespace">     </span><span class="mi">16</span><span class="sd">     Parameters</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">     </span><span class="mi">21</span><span class="sd">         local path of the file</span>
<span class="g g-Whitespace">     </span><span class="mi">22</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">---&gt; </span><span class="mi">23</span>     <span class="n">res0</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">24</span>     <span class="k">assert</span> <span class="s2">&quot;Content-Length&quot;</span> <span class="ow">in</span> <span class="n">res0</span><span class="o">.</span><span class="n">headers</span>
<span class="g g-Whitespace">     </span><span class="mi">25</span>     <span class="n">file_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">res0</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">])</span>

<span class="nn">File ~/.cache/pypoetry/virtualenvs/gpbp-OIyr1Vno-py3.10/lib/python3.10/site-packages/requests/api.py:100,</span> in <span class="ni">head</span><span class="nt">(url, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">89</span><span class="w"> </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Sends a HEAD request.</span>
<span class="g g-Whitespace">     </span><span class="mi">90</span><span class="sd"> </span>
<span class="g g-Whitespace">     </span><span class="mi">91</span><span class="sd"> :param url: URL for the new :class:`Request` object.</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">     </span><span class="mi">96</span><span class="sd"> :rtype: requests.Response</span>
<span class="g g-Whitespace">     </span><span class="mi">97</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="g g-Whitespace">     </span><span class="mi">99</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;allow_redirects&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">100</span> <span class="k">return</span> <span class="n">request</span><span class="p">(</span><span class="s2">&quot;head&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">File ~/.cache/pypoetry/virtualenvs/gpbp-OIyr1Vno-py3.10/lib/python3.10/site-packages/requests/api.py:59,</span> in <span class="ni">request</span><span class="nt">(method, url, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">55</span> <span class="c1"># By using the &#39;with&#39; statement we are sure the session is closed, thus we</span>
<span class="g g-Whitespace">     </span><span class="mi">56</span> <span class="c1"># avoid leaving sockets open which can trigger a ResourceWarning in some</span>
<span class="g g-Whitespace">     </span><span class="mi">57</span> <span class="c1"># cases, and look like a memory leak in others.</span>
<span class="g g-Whitespace">     </span><span class="mi">58</span> <span class="k">with</span> <span class="n">sessions</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">59</span>     <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">File ~/.cache/pypoetry/virtualenvs/gpbp-OIyr1Vno-py3.10/lib/python3.10/site-packages/requests/sessions.py:589,</span> in <span class="ni">Session.request</span><span class="nt">(self, method, url, params, data, headers, cookies, files, auth, timeout, allow_redirects, proxies, hooks, stream, verify, cert, json)</span>
<span class="g g-Whitespace">    </span><span class="mi">584</span> <span class="n">send_kwargs</span> <span class="o">=</span> <span class="p">{</span>
<span class="g g-Whitespace">    </span><span class="mi">585</span>     <span class="s2">&quot;timeout&quot;</span><span class="p">:</span> <span class="n">timeout</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">586</span>     <span class="s2">&quot;allow_redirects&quot;</span><span class="p">:</span> <span class="n">allow_redirects</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">587</span> <span class="p">}</span>
<span class="g g-Whitespace">    </span><span class="mi">588</span> <span class="n">send_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">589</span> <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">prep</span><span class="p">,</span> <span class="o">**</span><span class="n">send_kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">591</span> <span class="k">return</span> <span class="n">resp</span>

<span class="nn">File ~/.cache/pypoetry/virtualenvs/gpbp-OIyr1Vno-py3.10/lib/python3.10/site-packages/requests/sessions.py:703,</span> in <span class="ni">Session.send</span><span class="nt">(self, request, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">700</span> <span class="n">start</span> <span class="o">=</span> <span class="n">preferred_clock</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">702</span> <span class="c1"># Send the request</span>
<span class="ne">--&gt; </span><span class="mi">703</span> <span class="n">r</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">705</span> <span class="c1"># Total elapsed time of the request (approximately)</span>
<span class="g g-Whitespace">    </span><span class="mi">706</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="n">preferred_clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="nn">File ~/.cache/pypoetry/virtualenvs/gpbp-OIyr1Vno-py3.10/lib/python3.10/site-packages/requests/adapters.py:667,</span> in <span class="ni">HTTPAdapter.send</span><span class="nt">(self, request, stream, timeout, verify, cert, proxies)</span>
<span class="g g-Whitespace">    </span><span class="mi">664</span>     <span class="n">timeout</span> <span class="o">=</span> <span class="n">TimeoutSauce</span><span class="p">(</span><span class="n">connect</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">666</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">667</span>     <span class="n">resp</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">668</span>         <span class="n">method</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">669</span>         <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">670</span>         <span class="n">body</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">671</span>         <span class="n">headers</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">672</span>         <span class="n">redirect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">673</span>         <span class="n">assert_same_host</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">674</span>         <span class="n">preload_content</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">675</span>         <span class="n">decode_content</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">676</span>         <span class="n">retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">677</span>         <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">678</span>         <span class="n">chunked</span><span class="o">=</span><span class="n">chunked</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">679</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">681</span> <span class="k">except</span> <span class="p">(</span><span class="n">ProtocolError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">682</span>     <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>

<span class="nn">File ~/.cache/pypoetry/virtualenvs/gpbp-OIyr1Vno-py3.10/lib/python3.10/site-packages/urllib3/connectionpool.py:787,</span> in <span class="ni">HTTPConnectionPool.urlopen</span><span class="nt">(self, method, url, body, headers, retries, redirect, assert_same_host, timeout, pool_timeout, release_conn, chunked, body_pos, preload_content, decode_content, **response_kw)</span>
<span class="g g-Whitespace">    </span><span class="mi">784</span> <span class="n">response_conn</span> <span class="o">=</span> <span class="n">conn</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">release_conn</span> <span class="k">else</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">786</span> <span class="c1"># Make the request on the HTTPConnection object</span>
<span class="ne">--&gt; </span><span class="mi">787</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">788</span>     <span class="n">conn</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">789</span>     <span class="n">method</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">790</span>     <span class="n">url</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">791</span>     <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_obj</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">792</span>     <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">793</span>     <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">794</span>     <span class="n">chunked</span><span class="o">=</span><span class="n">chunked</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">795</span>     <span class="n">retries</span><span class="o">=</span><span class="n">retries</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">796</span>     <span class="n">response_conn</span><span class="o">=</span><span class="n">response_conn</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">797</span>     <span class="n">preload_content</span><span class="o">=</span><span class="n">preload_content</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">798</span>     <span class="n">decode_content</span><span class="o">=</span><span class="n">decode_content</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">799</span>     <span class="o">**</span><span class="n">response_kw</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">800</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">802</span> <span class="c1"># Everything went great!</span>
<span class="g g-Whitespace">    </span><span class="mi">803</span> <span class="n">clean_exit</span> <span class="o">=</span> <span class="kc">True</span>

<span class="nn">File ~/.cache/pypoetry/virtualenvs/gpbp-OIyr1Vno-py3.10/lib/python3.10/site-packages/urllib3/connectionpool.py:464,</span> in <span class="ni">HTTPConnectionPool._make_request</span><span class="nt">(self, conn, method, url, body, headers, retries, timeout, chunked, response_conn, preload_content, decode_content, enforce_content_length)</span>
<span class="g g-Whitespace">    </span><span class="mi">461</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">462</span>     <span class="c1"># Trigger any extra validation we need to do.</span>
<span class="g g-Whitespace">    </span><span class="mi">463</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">464</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_validate_conn</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">465</span>     <span class="k">except</span> <span class="p">(</span><span class="n">SocketTimeout</span><span class="p">,</span> <span class="n">BaseSSLError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">466</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_raise_timeout</span><span class="p">(</span><span class="n">err</span><span class="o">=</span><span class="n">e</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout_value</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>

<span class="nn">File ~/.cache/pypoetry/virtualenvs/gpbp-OIyr1Vno-py3.10/lib/python3.10/site-packages/urllib3/connectionpool.py:1093,</span> in <span class="ni">HTTPSConnectionPool._validate_conn</span><span class="nt">(self, conn)</span>
<span class="g g-Whitespace">   </span><span class="mi">1091</span> <span class="c1"># Force connect early to allow us to validate the connection.</span>
<span class="g g-Whitespace">   </span><span class="mi">1092</span> <span class="k">if</span> <span class="n">conn</span><span class="o">.</span><span class="n">is_closed</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1093</span>     <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="g g-Whitespace">   </span><span class="mi">1095</span> <span class="c1"># TODO revise this, see https://github.com/urllib3/urllib3/issues/2791</span>
<span class="g g-Whitespace">   </span><span class="mi">1096</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">conn</span><span class="o">.</span><span class="n">is_verified</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">conn</span><span class="o">.</span><span class="n">proxy_is_verified</span><span class="p">:</span>

<span class="nn">File ~/.cache/pypoetry/virtualenvs/gpbp-OIyr1Vno-py3.10/lib/python3.10/site-packages/urllib3/connection.py:741,</span> in <span class="ni">HTTPSConnection.connect</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">738</span>     <span class="c1"># Remove trailing &#39;.&#39; from fqdn hostnames to allow certificate validation</span>
<span class="g g-Whitespace">    </span><span class="mi">739</span>     <span class="n">server_hostname_rm_dot</span> <span class="o">=</span> <span class="n">server_hostname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">741</span>     <span class="n">sock_and_verified</span> <span class="o">=</span> <span class="n">_ssl_wrap_socket_and_match_hostname</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">742</span>         <span class="n">sock</span><span class="o">=</span><span class="n">sock</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">743</span>         <span class="n">cert_reqs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cert_reqs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">744</span>         <span class="n">ssl_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ssl_version</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">745</span>         <span class="n">ssl_minimum_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ssl_minimum_version</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">746</span>         <span class="n">ssl_maximum_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ssl_maximum_version</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">747</span>         <span class="n">ca_certs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ca_certs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">748</span>         <span class="n">ca_cert_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ca_cert_dir</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">749</span>         <span class="n">ca_cert_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ca_cert_data</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">750</span>         <span class="n">cert_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cert_file</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">751</span>         <span class="n">key_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key_file</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">752</span>         <span class="n">key_password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key_password</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">753</span>         <span class="n">server_hostname</span><span class="o">=</span><span class="n">server_hostname_rm_dot</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">754</span>         <span class="n">ssl_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ssl_context</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">755</span>         <span class="n">tls_in_tls</span><span class="o">=</span><span class="n">tls_in_tls</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">756</span>         <span class="n">assert_hostname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assert_hostname</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">757</span>         <span class="n">assert_fingerprint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assert_fingerprint</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">758</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">759</span>     <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">sock_and_verified</span><span class="o">.</span><span class="n">socket</span>
<span class="g g-Whitespace">    </span><span class="mi">761</span> <span class="c1"># If an error occurs during connection/handshake we may need to release</span>
<span class="g g-Whitespace">    </span><span class="mi">762</span> <span class="c1"># our lock so another connection can probe the origin.</span>

<span class="nn">File ~/.cache/pypoetry/virtualenvs/gpbp-OIyr1Vno-py3.10/lib/python3.10/site-packages/urllib3/connection.py:920,</span> in <span class="ni">_ssl_wrap_socket_and_match_hostname</span><span class="nt">(sock, cert_reqs, ssl_version, ssl_minimum_version, ssl_maximum_version, cert_file, key_file, key_password, ca_certs, ca_cert_dir, ca_cert_data, assert_hostname, assert_fingerprint, server_hostname, ssl_context, tls_in_tls)</span>
<span class="g g-Whitespace">    </span><span class="mi">917</span>     <span class="k">if</span> <span class="n">is_ipaddress</span><span class="p">(</span><span class="n">normalized</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">918</span>         <span class="n">server_hostname</span> <span class="o">=</span> <span class="n">normalized</span>
<span class="ne">--&gt; </span><span class="mi">920</span> <span class="n">ssl_sock</span> <span class="o">=</span> <span class="n">ssl_wrap_socket</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">921</span>     <span class="n">sock</span><span class="o">=</span><span class="n">sock</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">922</span>     <span class="n">keyfile</span><span class="o">=</span><span class="n">key_file</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">923</span>     <span class="n">certfile</span><span class="o">=</span><span class="n">cert_file</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">924</span>     <span class="n">key_password</span><span class="o">=</span><span class="n">key_password</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">925</span>     <span class="n">ca_certs</span><span class="o">=</span><span class="n">ca_certs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">926</span>     <span class="n">ca_cert_dir</span><span class="o">=</span><span class="n">ca_cert_dir</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">927</span>     <span class="n">ca_cert_data</span><span class="o">=</span><span class="n">ca_cert_data</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">928</span>     <span class="n">server_hostname</span><span class="o">=</span><span class="n">server_hostname</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">929</span>     <span class="n">ssl_context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">930</span>     <span class="n">tls_in_tls</span><span class="o">=</span><span class="n">tls_in_tls</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">931</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">933</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">934</span>     <span class="k">if</span> <span class="n">assert_fingerprint</span><span class="p">:</span>

<span class="nn">File ~/.cache/pypoetry/virtualenvs/gpbp-OIyr1Vno-py3.10/lib/python3.10/site-packages/urllib3/util/ssl_.py:460,</span> in <span class="ni">ssl_wrap_socket</span><span class="nt">(sock, keyfile, certfile, cert_reqs, ca_certs, server_hostname, ssl_version, ciphers, ssl_context, ca_cert_dir, key_password, ca_cert_data, tls_in_tls)</span>
<span class="g g-Whitespace">    </span><span class="mi">456</span>         <span class="n">context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">certfile</span><span class="p">,</span> <span class="n">keyfile</span><span class="p">,</span> <span class="n">key_password</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">458</span> <span class="n">context</span><span class="o">.</span><span class="n">set_alpn_protocols</span><span class="p">(</span><span class="n">ALPN_PROTOCOLS</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">460</span> <span class="n">ssl_sock</span> <span class="o">=</span> <span class="n">_ssl_wrap_socket_impl</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">tls_in_tls</span><span class="p">,</span> <span class="n">server_hostname</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">461</span> <span class="k">return</span> <span class="n">ssl_sock</span>

<span class="nn">File ~/.cache/pypoetry/virtualenvs/gpbp-OIyr1Vno-py3.10/lib/python3.10/site-packages/urllib3/util/ssl_.py:504,</span> in <span class="ni">_ssl_wrap_socket_impl</span><span class="nt">(sock, ssl_context, tls_in_tls, server_hostname)</span>
<span class="g g-Whitespace">    </span><span class="mi">501</span>     <span class="n">SSLTransport</span><span class="o">.</span><span class="n">_validate_ssl_context_for_tls_in_tls</span><span class="p">(</span><span class="n">ssl_context</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">502</span>     <span class="k">return</span> <span class="n">SSLTransport</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">ssl_context</span><span class="p">,</span> <span class="n">server_hostname</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">504</span> <span class="k">return</span> <span class="n">ssl_context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span class="n">server_hostname</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.10.18/x64/lib/python3.10/ssl.py:513,</span> in <span class="ni">SSLContext.wrap_socket</span><span class="nt">(self, sock, server_side, do_handshake_on_connect, suppress_ragged_eofs, server_hostname, session)</span>
<span class="g g-Whitespace">    </span><span class="mi">507</span> <span class="k">def</span><span class="w"> </span><span class="nf">wrap_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">508</span>                 <span class="n">do_handshake_on_connect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">509</span>                 <span class="n">suppress_ragged_eofs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">510</span>                 <span class="n">server_hostname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">511</span>     <span class="c1"># SSLSocket class handles server_hostname encoding before it calls</span>
<span class="g g-Whitespace">    </span><span class="mi">512</span>     <span class="c1"># ctx._wrap_socket()</span>
<span class="ne">--&gt; </span><span class="mi">513</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sslsocket_class</span><span class="o">.</span><span class="n">_create</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">514</span>         <span class="n">sock</span><span class="o">=</span><span class="n">sock</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">515</span>         <span class="n">server_side</span><span class="o">=</span><span class="n">server_side</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">516</span>         <span class="n">do_handshake_on_connect</span><span class="o">=</span><span class="n">do_handshake_on_connect</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">517</span>         <span class="n">suppress_ragged_eofs</span><span class="o">=</span><span class="n">suppress_ragged_eofs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">518</span>         <span class="n">server_hostname</span><span class="o">=</span><span class="n">server_hostname</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">519</span>         <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">520</span>         <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="g g-Whitespace">    </span><span class="mi">521</span>     <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.10.18/x64/lib/python3.10/ssl.py:1104,</span> in <span class="ni">SSLSocket._create</span><span class="nt">(cls, sock, server_side, do_handshake_on_connect, suppress_ragged_eofs, server_hostname, context, session)</span>
<span class="g g-Whitespace">   </span><span class="mi">1101</span>         <span class="k">if</span> <span class="n">timeout</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1102</span>             <span class="c1"># non-blocking</span>
<span class="g g-Whitespace">   </span><span class="mi">1103</span>             <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;do_handshake_on_connect should not be specified for non-blocking sockets&quot;</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1104</span>         <span class="bp">self</span><span class="o">.</span><span class="n">do_handshake</span><span class="p">()</span>
<span class="g g-Whitespace">   </span><span class="mi">1105</span> <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1106</span>     <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.10.18/x64/lib/python3.10/ssl.py:1375,</span> in <span class="ni">SSLSocket.do_handshake</span><span class="nt">(self, block)</span>
<span class="g g-Whitespace">   </span><span class="mi">1373</span>     <span class="k">if</span> <span class="n">timeout</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">block</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1374</span>         <span class="bp">self</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1375</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_sslobj</span><span class="o">.</span><span class="n">do_handshake</span><span class="p">()</span>
<span class="g g-Whitespace">   </span><span class="mi">1376</span> <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1377</span>     <span class="bp">self</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
</section>
<section id="facilities">
<h2>Facilities<a class="headerlink" href="#facilities" title="Link to this heading"></a></h2>
<section id="get-existing-facilities-in-our-case-hospitals-from-osm">
<h3>Get existing facilities (in our case, hospitals) from OSM<a class="headerlink" href="#get-existing-facilities-in-our-case-hospitals-from-osm" title="Link to this heading"></a></h3>
<p>We first identify the existing hospitals in <code class="docutils literal notranslate"><span class="pre">Baucau</span></code> by calling the <code class="docutils literal notranslate"><span class="pre">get_existing_facilities</span></code> method on the <code class="docutils literal notranslate"><span class="pre">Facilities</span></code> class, which takes the administrative area boundaries as input. This method fetches the existing facilities from OpenStreetMap (OSM).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Suppress user warning about geometry in geographic CRS. Centroid is calculated over a single facility (e.g. a hospital),</span>
<span class="c1"># so distances are very small and projection isn&#39;t necessary</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
    <span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Geometry is in a geographic CRS. Results from &#39;centroid&#39; are likely incorrect&quot;</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">hospitals_df</span> <span class="o">=</span> <span class="n">Facilities</span><span class="p">(</span><span class="n">admin_area_boundaries</span><span class="o">=</span><span class="n">baucau</span><span class="p">)</span><span class="o">.</span><span class="n">get_existing_facilities</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_facilities</span><span class="p">(</span><span class="n">hospitals_df</span><span class="p">,</span> <span class="n">baucau</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="estimate-potential-locations-for-new-facilities">
<h3>Estimate potential locations for new facilities<a class="headerlink" href="#estimate-potential-locations-for-new-facilities" title="Link to this heading"></a></h3>
<p>We then identify potential locations for new hospitals in <code class="docutils literal notranslate"><span class="pre">Baucau</span></code> by drawing a grid over the area. The <code class="docutils literal notranslate"><span class="pre">spacing</span></code> parameter specifies the distance between potential facilities. In this case, we use a spacing of 0.05.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">potential_hospitals_df</span> <span class="o">=</span> <span class="n">Facilities</span><span class="p">(</span>
    <span class="n">admin_area_boundaries</span><span class="o">=</span><span class="n">baucau</span>
<span class="p">)</span><span class="o">.</span><span class="n">estimate_potential_facilities</span><span class="p">(</span><span class="n">spacing</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="get-population">
<h2>Get population<a class="headerlink" href="#get-population" title="Link to this heading"></a></h2>
<p>We get the population data for <code class="docutils literal notranslate"><span class="pre">Baucau</span></code> from WorldPop by calling the <code class="docutils literal notranslate"><span class="pre">get_population_gdf</span></code> method on the <code class="docutils literal notranslate"><span class="pre">WorldpopPopulation</span></code> class, which takes the administrative area boundaries and the ISO3 country code as input parameters. The ISO3 country code is obtained from the <code class="docutils literal notranslate"><span class="pre">AdministrativeArea</span></code> object.</p>
<p>WorldPop always provides the most recent population data available, which is usually from the previous year. There is also a possibility to use Facebook population data in the PISA package, but the most recent data available is from 2019. In this example, we use WorldPop.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">population_gdf</span> <span class="o">=</span> <span class="n">WorldpopPopulation</span><span class="p">(</span>
    <span class="n">admin_area_boundaries</span><span class="o">=</span><span class="n">baucau</span><span class="p">,</span> <span class="n">iso3_country_code</span><span class="o">=</span><span class="n">timor_leste</span><span class="o">.</span><span class="n">get_iso3_country_code</span><span class="p">()</span>
<span class="p">)</span><span class="o">.</span><span class="n">get_population_gdf</span><span class="p">()</span>

<span class="n">population_gdf</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_population_heatmap</span><span class="p">(</span><span class="n">population_gdf</span><span class="p">,</span> <span class="n">baucau</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_population</span><span class="p">(</span><span class="n">population_gdf</span><span class="p">,</span> <span class="n">baucau</span><span class="p">,</span> <span class="n">random_sample_n</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-isopolygons">
<h2>Calculate isopolygons<a class="headerlink" href="#calculate-isopolygons" title="Link to this heading"></a></h2>
<p>We specify the parameters for determining access to existing and potential facilities.</p>
<p>For this we make choices on:</p>
<ul class="simple">
<li><p>distance type: in this notebook we use <code class="docutils literal notranslate"><span class="pre">length</span></code> (i.e. distance in meters) as the distance type, but it could also be <code class="docutils literal notranslate"><span class="pre">time</span></code> (i.e. travel time in minutes)</p></li>
<li><p>distance values: these are the distances we want to use to determine access to hospitals. In this example, we use 2000, 5000 and 10000 meters (i.e. 2, 5 and 10 km) as the distance values.</p></li>
<li><p>mode of transport: in this example, we use <code class="docutils literal notranslate"><span class="pre">driving</span></code> as the mode of transport, but it could also be <code class="docutils literal notranslate"><span class="pre">walking</span></code> or <code class="docutils literal notranslate"><span class="pre">cycling</span></code>.</p></li>
</ul>
<p>Valid values for constants can be found in the script pisa.constants</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DISTANCE_TYPE</span> <span class="o">=</span> <span class="s2">&quot;length&quot;</span>

<span class="n">DISTANCE_VALUES</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">]</span>

<span class="n">MODE_OF_TRANSPORT</span> <span class="o">=</span> <span class="s2">&quot;driving&quot;</span>
</pre></div>
</div>
</div>
</div>
<section id="using-osm">
<h3>Using OSM<a class="headerlink" href="#using-osm" title="Link to this heading"></a></h3>
<p>In order to determine the population that lives 10 km or less driving from an existing or potential facility, we need to get the road network from OSM. This can be done by calling the <code class="docutils literal notranslate"><span class="pre">get_osm_road_network</span></code> method on the <code class="docutils literal notranslate"><span class="pre">OsmRoadNetwork</span></code> class, which takes the administrative area boundaries, mode of transport, and distance type as input parameters. This will return the road network for the specific input parameters that can be used in the following step.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pisa.osm_road_network</span><span class="w"> </span><span class="kn">import</span> <span class="n">OsmRoadNetwork</span>

<span class="n">road_network</span> <span class="o">=</span> <span class="n">OsmRoadNetwork</span><span class="p">(</span>
    <span class="n">admin_area_boundaries</span><span class="o">=</span><span class="n">baucau</span><span class="p">,</span>
    <span class="n">mode_of_transport</span><span class="o">=</span><span class="n">MODE_OF_TRANSPORT</span><span class="p">,</span>
    <span class="n">distance_type</span><span class="o">=</span><span class="n">DISTANCE_TYPE</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">get_osm_road_network</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-isopolygons-for-existing-facilities">
<h3>Calculate isopolygons for existing facilities<a class="headerlink" href="#calculate-isopolygons-for-existing-facilities" title="Link to this heading"></a></h3>
<p>We calculate the areas (isopolygons) around the existing facilities that are reachable within the specified distances and transport mode. This is done by using the <code class="docutils literal notranslate"><span class="pre">calculate_isopolygons</span></code> method of the <code class="docutils literal notranslate"><span class="pre">OsmIsopolygonCalculator</span></code> class, which takes the existing facilities, distance type, distance values, and road network as input parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pisa.isopolygons</span><span class="w"> </span><span class="kn">import</span> <span class="n">OsmIsopolygonCalculator</span>

<span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>
    <span class="n">isopolygons_existing_facilities</span> <span class="o">=</span> <span class="n">OsmIsopolygonCalculator</span><span class="p">(</span>
    <span class="n">facilities_df</span><span class="o">=</span><span class="n">hospitals_df</span><span class="p">,</span>
    <span class="n">distance_type</span><span class="o">=</span><span class="n">DISTANCE_TYPE</span><span class="p">,</span>
    <span class="n">distance_values</span><span class="o">=</span><span class="n">DISTANCE_VALUES</span><span class="p">,</span>
    <span class="n">road_network</span><span class="o">=</span><span class="n">road_network</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">calculate_isopolygons</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">isopolygons_existing_facilities</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_isochrones</span><span class="p">(</span><span class="n">isopolygons_existing_facilities</span><span class="p">,</span> <span class="n">baucau</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-isopolygons-for-potential-facilities">
<h3>Calculate isopolygons for potential facilities<a class="headerlink" href="#calculate-isopolygons-for-potential-facilities" title="Link to this heading"></a></h3>
<p>We do the same for the potential facilities. This will give us the areas around the potential facilities that are reachable within the specified distances and transport mode.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>
    <span class="n">isopolygons_potential_facilities</span> <span class="o">=</span> <span class="n">OsmIsopolygonCalculator</span><span class="p">(</span>
    <span class="n">facilities_df</span><span class="o">=</span><span class="n">potential_hospitals_df</span><span class="p">,</span>
    <span class="n">distance_type</span><span class="o">=</span><span class="n">DISTANCE_TYPE</span><span class="p">,</span>
    <span class="n">distance_values</span><span class="o">=</span><span class="n">DISTANCE_VALUES</span><span class="p">,</span>
    <span class="n">road_network</span><span class="o">=</span><span class="n">road_network</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">calculate_isopolygons</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="get-population-served-by-isopolygons">
<h3>Get population served by isopolygons<a class="headerlink" href="#get-population-served-by-isopolygons" title="Link to this heading"></a></h3>
<p>We can now calculate the population that lives within the isopolygons for both existing and potential facilities. This is done by using the <code class="docutils literal notranslate"><span class="pre">get_population_served_by_isopolygons</span></code> function, which takes the population data and the isopolygons as input parameters. We save this value in a dictionary with the distance type as key.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">population_served_current</span> <span class="o">=</span> <span class="n">get_population_served_by_isopolygons</span><span class="p">(</span>
    <span class="n">grouped_population</span><span class="o">=</span><span class="n">population_gdf</span><span class="p">,</span> <span class="n">isopolygons</span><span class="o">=</span><span class="n">isopolygons_existing_facilities</span>
<span class="p">)</span>

<span class="n">current</span> <span class="o">=</span> <span class="p">{</span><span class="n">DISTANCE_TYPE</span><span class="p">:</span> <span class="n">population_served_current</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">population_served_potential</span> <span class="o">=</span> <span class="n">get_population_served_by_isopolygons</span><span class="p">(</span>
    <span class="n">grouped_population</span><span class="o">=</span><span class="n">population_gdf</span><span class="p">,</span> <span class="n">isopolygons</span><span class="o">=</span><span class="n">isopolygons_potential_facilities</span>
<span class="p">)</span>

<span class="n">potential</span> <span class="o">=</span> <span class="p">{</span><span class="n">DISTANCE_TYPE</span><span class="p">:</span> <span class="n">population_served_potential</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="prepare-optimization-data">
<h2>Prepare optimization data<a class="headerlink" href="#prepare-optimization-data" title="Link to this heading"></a></h2>
<p>Preparing the variables that go into the optimization:</p>
<ol class="arabic simple">
<li><p>We define the population count, which is the total population in the area of interest. This is used to calculate the number of people that can be served by the existing and potential facilities.</p></li>
<li><p>We define the budget for the optimization, which is the number of locations that can be built. In this example, we use a budget of 5, 20 and 50 locations.</p></li>
<li><p>We set the optimization method to use the CBC solver. The <code class="docutils literal notranslate"><span class="pre">jg_opt.OpenOptimize</span></code> function is used to create an optimization object with the specified solver path (defined in a .env file).</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">population_count</span> <span class="o">=</span> <span class="n">population_gdf</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">BUDGET</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">20</span><span class="p">,</span>
    <span class="mi">50</span><span class="p">,</span>
<span class="p">]</span>  <span class="c1"># budget for the optimization in terms of how many locations can be built</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cbc_optimize</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">jg_opt</span><span class="o">.</span><span class="n">OpenOptimize</span><span class="p">,</span> <span class="n">solver_path</span><span class="o">=</span><span class="n">CBC_SOLVER_PATH</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="optimization">
<h3>Optimization<a class="headerlink" href="#optimization" title="Link to this heading"></a></h3>
<p>We run the optimization using the <code class="docutils literal notranslate"><span class="pre">jg_opt.Solve</span></code> function, which takes the population count, current population served by existing facilities, population that could be served by the potential facilities, distance type, budget, and optimization method as input parameters. The optimization will return the values (percentage of population that can be reached with the new facilities) and solutions (the best locations for new facilities) for the specified budgets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">values</span><span class="p">,</span> <span class="n">solutions</span> <span class="o">=</span> <span class="n">jg_opt</span><span class="o">.</span><span class="n">Solve</span><span class="p">(</span>
    <span class="n">household</span><span class="o">=</span><span class="n">population_count</span><span class="p">,</span>
    <span class="n">current</span><span class="o">=</span><span class="n">current</span><span class="p">,</span>
    <span class="n">potential</span><span class="o">=</span><span class="n">potential</span><span class="p">,</span>
    <span class="n">accessibility</span><span class="o">=</span><span class="n">DISTANCE_TYPE</span><span class="p">,</span>
    <span class="n">budgets</span><span class="o">=</span><span class="n">BUDGET</span><span class="p">,</span>
    <span class="n">optimize</span><span class="o">=</span><span class="n">cbc_optimize</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;ID&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">solutions</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../index.html" class="btn btn-neutral float-left" title="Public Infrastructure Service Access (PISA)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../contributing.html" class="btn btn-neutral float-right" title="Contributing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>